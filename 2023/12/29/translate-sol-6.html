

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="vc">
  <meta name="keywords" content="">
  
    <meta name="description" content="原文 Sol - An MQTT broker from scratch. Part 6 - Handlers">
<meta property="og:type" content="article">
<meta property="og:title" content="[翻译]Sol - 从零开始的MQTT broker - 第六部分：处理器">
<meta property="og:url" content="https://vitsumoc.github.io/2023/12/29/translate-sol-6.html">
<meta property="og:site_name" content="Thinking...">
<meta property="og:description" content="原文 Sol - An MQTT broker from scratch. Part 6 - Handlers">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://vitsumoc.github.io/2023/12/29/translate-sol-6/QoS2-sample.png">
<meta property="article:published_time" content="2023-12-29T00:56:57.000Z">
<meta property="article:modified_time" content="2024-01-02T09:14:39.148Z">
<meta property="article:author" content="vc">
<meta property="article:tag" content="网络编程">
<meta property="article:tag" content="翻译">
<meta property="article:tag" content="物联网">
<meta property="article:tag" content="C">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://vitsumoc.github.io/2023/12/29/translate-sol-6/QoS2-sample.png">
  
  
  
  <title>[翻译]Sol - 从零开始的MQTT broker - 第六部分：处理器 - Thinking...</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"vitsumoc.github.io","root":"/","version":"1.9.6","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":3},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 60vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Thinking...</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">[翻译]Sol - 从零开始的MQTT broker - 第六部分：处理器</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-12-29 08:56" pubdate>
          2023年12月29日 早上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          2.5k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          21 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">[翻译]Sol - 从零开始的MQTT broker - 第六部分：处理器</h1>
            
            
              <div class="markdown-body">
                
                <blockquote>
<p>原文 <a target="_blank" rel="noopener" href="https://codepr.github.io/posts/sol-mqtt-broker-p6/">Sol - An MQTT broker from scratch. Part 6 - Handlers</a></p>
</blockquote>
<span id="more"></span>

<p>这一部分我们会重点关注 <strong>处理器（handler）</strong> 的实现，每种处理器用来处理一种对应的MQTT包。就像我们在第四部分中已经描述的，我们把处理器放在一个固定长度的数组里，每个处理器的索引恰好是包的MQTT类型。</p>
<h1 id="业务封装"><a href="#业务封装" class="headerlink" title="业务封装"></a>业务封装</h1><p>在我们开始主要工作之前，我们先补充一些前几章缺失的业务代码：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><div class="caption"><span>src/core.h</span></div><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"trie.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"list.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"hashtable.h"</span></span>

<span class="token keyword">struct</span> <span class="token class-name">topic</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    List <span class="token operator">*</span>subscribers<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// sol的主体结构, 服务器运行时会产生一个全局实例</span>
<span class="token comment">// 包括了所有连接的客户端、闭包和主题树</span>
<span class="token keyword">struct</span> <span class="token class-name">sol</span> <span class="token punctuation">&#123;</span>
    HashTable <span class="token operator">*</span>clients<span class="token punctuation">;</span>
    HashTable <span class="token operator">*</span>closures<span class="token punctuation">;</span>
    Trie topics<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 在客户端中使用的session, 保存该客户端订阅的所有主题</span>
<span class="token keyword">struct</span> <span class="token class-name">session</span> <span class="token punctuation">&#123;</span>
    List <span class="token operator">*</span>subscriptions<span class="token punctuation">;</span>
    <span class="token comment">// TODO add pending confirmed messages</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 客户端包装</span>
<span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>client_id<span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">session</span> session<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 将客户端包装成订阅者, 之后由主题保存订阅者列表</span>
<span class="token keyword">struct</span> <span class="token class-name">subscriber</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> qos<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token operator">*</span>client<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 主题创建、订阅发布的一系列方法</span>
<span class="token keyword">struct</span> <span class="token class-name">topic</span> <span class="token operator">*</span><span class="token function">topic_create</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">topic_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">topic</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">topic_add_subscriber</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">topic</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span><span class="token punctuation">,</span> bool<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">topic_del_subscriber</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">topic</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token operator">*</span><span class="token punctuation">,</span> bool<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">sol_topic_put</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sol</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">topic</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">sol_topic_del</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sol</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 通过主题名称获得主题</span>
<span class="token keyword">struct</span> <span class="token class-name">topic</span> <span class="token operator">*</span><span class="token function">sol_topic_get</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sol</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>这部分主要实现了客户端和服务端交互的各种抽象：</p>
<ul>
<li>客户端（client）结构体，用来表示已经建立连接的客户端</li>
<li>主题（topic）结构体</li>
<li>订阅者（subscriber）结构体</li>
<li>会话结（session）构体，表示客户端持有的会话，仅当 <code>clean session</code> 选项为 <code>false</code> 时生效</li>
<li>sol结构体，全局运行实例，用来持有上述的所有内容</li>
<li>一些方便的辅助函数</li>
</ul>
<p>这里是上述定义的实现：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><div class="caption"><span>src/core.c</span></div><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"core.h"</span></span>

<span class="token comment">// 传入两个订阅者, 比较其客户端id</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">compare_cid</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>c1<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>c2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">subscriber</span> <span class="token operator">*</span><span class="token punctuation">)</span> c1<span class="token punctuation">)</span><span class="token operator">-></span>client<span class="token operator">-></span>client_id<span class="token punctuation">,</span>
                  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">subscriber</span> <span class="token operator">*</span><span class="token punctuation">)</span> c2<span class="token punctuation">)</span><span class="token operator">-></span>client<span class="token operator">-></span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 创建一个topic对象</span>
<span class="token keyword">struct</span> <span class="token class-name">topic</span> <span class="token operator">*</span><span class="token function">topic_create</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">topic</span> <span class="token operator">*</span>t <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">topic_init</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> t<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">topic_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">topic</span> <span class="token operator">*</span>t<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    t<span class="token operator">-></span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    t<span class="token operator">-></span>subscribers <span class="token operator">=</span> <span class="token function">list_create</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 向主题对象内添加一个订阅者</span>
<span class="token keyword">void</span> <span class="token function">topic_add_subscriber</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">topic</span> <span class="token operator">*</span>t<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token operator">*</span>client<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> qos<span class="token punctuation">,</span> bool cleansession<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">subscriber</span> <span class="token operator">*</span>sub <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>sub<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sub<span class="token operator">-></span>client <span class="token operator">=</span> client<span class="token punctuation">;</span>
    sub<span class="token operator">-></span>qos <span class="token operator">=</span> qos<span class="token punctuation">;</span>
    t<span class="token operator">-></span>subscribers <span class="token operator">=</span> <span class="token function">list_push</span><span class="token punctuation">(</span>t<span class="token operator">-></span>subscribers<span class="token punctuation">,</span> sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果cleansession置为false，必须将此订阅加入会话</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cleansession<span class="token punctuation">)</span>
        client<span class="token operator">-></span>session<span class="token punctuation">.</span>subscriptions <span class="token operator">=</span> <span class="token function">list_push</span><span class="token punctuation">(</span>client<span class="token operator">-></span>session<span class="token punctuation">.</span>subscriptions<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 主题取消客户端订阅</span>
<span class="token keyword">void</span> <span class="token function">topic_del_subscriber</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">topic</span> <span class="token operator">*</span>t<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token operator">*</span>client<span class="token punctuation">,</span> bool cleansession<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">list_remove_node</span><span class="token punctuation">(</span>t<span class="token operator">-></span>subscribers<span class="token punctuation">,</span> client<span class="token punctuation">,</span> compare_cid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO remomve in case of cleansession == false</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 向sol设置主题</span>
<span class="token keyword">void</span> <span class="token function">sol_topic_put</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sol</span> <span class="token operator">*</span>sol<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">topic</span> <span class="token operator">*</span>t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">trie_insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sol<span class="token operator">-></span>topics<span class="token punctuation">,</span> t<span class="token operator">-></span>name<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 向sol删除主题</span>
<span class="token keyword">void</span> <span class="token function">sol_topic_del</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sol</span> <span class="token operator">*</span>sol<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">trie_delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sol<span class="token operator">-></span>topics<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 查询获得一个主题</span>
<span class="token keyword">struct</span> <span class="token class-name">topic</span> <span class="token operator">*</span><span class="token function">sol_topic_get</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sol</span> <span class="token operator">*</span>sol<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">topic</span> <span class="token operator">*</span>ret_topic<span class="token punctuation">;</span>
    <span class="token function">trie_find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sol<span class="token operator">-></span>topics<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>ret_topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret_topic<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="处理器实现"><a href="#处理器实现" class="headerlink" title="处理器实现"></a>处理器实现</h1><p><code>处理器（Handlers）</code> 是一系列会在 <code>on_read</code> 中被执行的回调函数，就像他们的名称暗示的一样，他们负责处理客户端输入的数据，之后他们选择性的创建或不创建一个回复数据，并且返回一个指示下一步应该如何处理的返回值。返回值可以是：</p>
<ul>
<li><code>REARM_W</code>，表示将下一个触发函数设置为 <code>on_write</code>，并提供需要发送到客户端的数据</li>
<li><code>REARM_R</code>，表示没有需要回复客户端的数据，可以继续将触发函数重置为 <code>on_read</code>，继续等待客户端数据</li>
<li><code>-REARM_W</code>，这个状态码没有被协议定义，我们在这里用来表示客户端断开链接或者故障发生</li>
</ul>
<h2 id="CONNECT-处理器"><a href="#CONNECT-处理器" class="headerlink" title="CONNECT 处理器"></a>CONNECT 处理器</h2><p>按照顺序，我们先来实现 <code>connect_handler</code>，顾名思义，他用来处理客户端完成TCP链接之后发来的第一个数据包，也就是 <code>CONNECT</code> 包。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><div class="caption"><span>src/server.c</span></div><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">connect_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">closure</span> <span class="token operator">*</span>cb<span class="token punctuation">,</span> <span class="token keyword">union</span> mqtt_packet <span class="token operator">*</span>pkt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 当一个已存在的客户端又发送了 CONNECT 包, 被视为违背协议</span>
    <span class="token comment">// 因此断开链接</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hashtable_exists</span><span class="token punctuation">(</span>sol<span class="token punctuation">.</span>clients<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> pkt<span class="token operator">-></span>connect<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>client_id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">sol_info</span><span class="token punctuation">(</span><span class="token string">"Received double CONNECT from %s, disconnecting client"</span><span class="token punctuation">,</span>
                 pkt<span class="token operator">-></span>connect<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 关闭链接, 释放资源</span>
        <span class="token function">close</span><span class="token punctuation">(</span>cb<span class="token operator">-></span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 哈希表删除时的回调会负责销毁 client 或者 cb</span>
        <span class="token function">hashtable_del</span><span class="token punctuation">(</span>sol<span class="token punctuation">.</span>clients<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> pkt<span class="token operator">-></span>connect<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">hashtable_del</span><span class="token punctuation">(</span>sol<span class="token punctuation">.</span>closures<span class="token punctuation">,</span> cb<span class="token operator">-></span>closure_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 更新状态</span>
        info<span class="token punctuation">.</span>nclients<span class="token operator">--</span><span class="token punctuation">;</span>
        info<span class="token punctuation">.</span>nconnections<span class="token operator">--</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token operator">-</span>REARM_W<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">sol_info</span><span class="token punctuation">(</span><span class="token string">"New client connected as %s (c%i, k%u)"</span><span class="token punctuation">,</span>
             pkt<span class="token operator">-></span>connect<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>client_id<span class="token punctuation">,</span>
             pkt<span class="token operator">-></span>connect<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>clean_session<span class="token punctuation">,</span>
             pkt<span class="token operator">-></span>connect<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>keepalive<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 添加新链接</span>
    <span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token operator">*</span>new_client <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>new_client<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    new_client<span class="token operator">-></span>fd <span class="token operator">=</span> cb<span class="token operator">-></span>fd<span class="token punctuation">;</span>
    <span class="token comment">// 由客户端保证cid的唯一性, 比如可以用mac地址</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> pkt<span class="token operator">-></span>connect<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>client_id<span class="token punctuation">;</span>
    new_client<span class="token operator">-></span>client_id <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>cid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">hashtable_put</span><span class="token punctuation">(</span>sol<span class="token punctuation">.</span>clients<span class="token punctuation">,</span> cid<span class="token punctuation">,</span> new_client<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将 clinet 绑定到闭包</span>
    cb<span class="token operator">-></span>obj <span class="token operator">=</span> new_client<span class="token punctuation">;</span>

    <span class="token comment">// 使用 CONNACK回复</span>
    <span class="token keyword">union</span> mqtt_packet <span class="token operator">*</span>response <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 高位赋值</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> byte <span class="token operator">=</span> CONNACK_BYTE<span class="token punctuation">;</span>

    <span class="token comment">// clean_session == false 表示此链接支持保存 session</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-></span>connect<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>clean_session <span class="token operator">==</span> false<span class="token punctuation">)</span>
        <span class="token comment">// 所以需要在会话中初始化订阅列表</span>
        new_client<span class="token operator">-></span>session<span class="token punctuation">.</span>subscriptions <span class="token operator">=</span> <span class="token function">list_create</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// TODO 处理确实存在session的情况</span>
    <span class="token comment">// 这里暂时是简单的返回 session 不存在</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> session_present <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> connect_flags <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">|</span> <span class="token punctuation">(</span>session_present <span class="token operator">&amp;</span> <span class="token number">0x1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> rc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 返回 0 表示接收链接</span>

    <span class="token comment">// 完成组包</span>
    response<span class="token operator">-></span>connack <span class="token operator">=</span> <span class="token operator">*</span><span class="token function">mqtt_packet_connack</span><span class="token punctuation">(</span>byte<span class="token punctuation">,</span> connect_flags<span class="token punctuation">,</span> rc<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 包编码成数据流</span>
    cb<span class="token operator">-></span>payload <span class="token operator">=</span> <span class="token function">bytestring_create</span><span class="token punctuation">(</span>MQTT_ACK_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">pack_mqtt_packet</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> CONNACK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>cb<span class="token operator">-></span>payload<span class="token operator">-></span>data<span class="token punctuation">,</span> p<span class="token punctuation">,</span> MQTT_ACK_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"Sending CONNACK to %s (%u, %u)"</span><span class="token punctuation">,</span>
              pkt<span class="token operator">-></span>connect<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>client_id<span class="token punctuation">,</span>
              session_present<span class="token punctuation">,</span> rc<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">free</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 标记之后发送</span>
    <span class="token keyword">return</span> REARM_W<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>我们严格按照协议规范实现了处理器行为，除了 <strong>clean session</strong> 标识的处理，对于有会话的客户端该如何重连这件事我们暂时忽略了。如果一个客户端传入了两次 CONNECT，按照协议规范我们会断开他的链接。正常情况下我们会记录客户端，制作一个 CONNACK 数据流，并且返回 <code>REARM_W</code>，让 <code>on_write</code> 可以把我们的数据流发送回客户端。</p>
<h2 id="DISCONNECT-处理器"><a href="#DISCONNECT-处理器" class="headerlink" title="DISCONNECT 处理器"></a>DISCONNECT 处理器</h2><p>下一个包，<code>DISCONNECT</code>：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><div class="caption"><span>src/server.c</span></div><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">disconnect_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">closure</span> <span class="token operator">*</span>cb<span class="token punctuation">,</span> <span class="token keyword">union</span> mqtt_packet <span class="token operator">*</span>pkt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 获得客户端</span>
    <span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token operator">*</span>c <span class="token operator">=</span> cb<span class="token operator">-></span>obj<span class="token punctuation">;</span>
    <span class="token comment">// 执行删除动作</span>
    <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"Received DISCONNECT from %s"</span><span class="token punctuation">,</span> c<span class="token operator">-></span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>c<span class="token operator">-></span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">hashtable_del</span><span class="token punctuation">(</span>sol<span class="token punctuation">.</span>clients<span class="token punctuation">,</span> c<span class="token operator">-></span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">hashtable_del</span><span class="token punctuation">(</span>sol<span class="token punctuation">.</span>closures<span class="token punctuation">,</span> cb<span class="token operator">-></span>closure_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 跟新状态</span>
    info<span class="token punctuation">.</span>nclients<span class="token operator">--</span><span class="token punctuation">;</span>
    info<span class="token punctuation">.</span>nconnections<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO 在该客户端订阅的所有主题中删除对其的引用</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>REARM_W<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>我们做了最简单的处理：日志记录、关闭 fd、从哈希表中删除、更新信息，然后返回一个负值。</p>
<h2 id="SUBSCRIBE-UNSUBSCRIBE-处理器"><a href="#SUBSCRIBE-UNSUBSCRIBE-处理器" class="headerlink" title="SUBSCRIBE UNSUBSCRIBE 处理器"></a>SUBSCRIBE UNSUBSCRIBE 处理器</h2><p><code>SUBSCRIBE</code> 的处理器则是一个更加有意思的操作，在这里我们需要用到我们的 <strong>特里树</strong>，大概流程如下：</p>
<ul>
<li>迭代传入的主题元组（包括 tpoic，QoS），对每一个主题进行如下操作：<ul>
<li>如果主题不存在，我们创建该主题</li>
<li>将客户端加入该主题的订阅者列表</li>
<li>如果主题以 <code>#</code> 结尾，我们需要让客户端订阅该主题以及该主题所有的下级节点，由于特里树的数据结构设计，这个操作可以轻松的递归处理</li>
<li>如果 <code>clean_session</code> 标识的值为 <code>false</code>，我们需要给客户端添加一个会话，这里我们还没有完全实现</li>
</ul>
</li>
<li>使用 <code>SUBACK</code> 回应</li>
</ul>
<p>在 <code>UNSUBSCRIBE</code> 中也没有什么意外，只要在主题中删除客户端，然后使用 <code>UNSUBACK</code> 回应即可。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><div class="caption"><span>src/server.c</span></div><code class="language-c"><span class="token comment">// 用递归方式来订阅一个节点所有子节点的辅助函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">recursive_subscription</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">trie_node</span> <span class="token operator">*</span>node<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node <span class="token operator">||</span> <span class="token operator">!</span>node<span class="token operator">-></span>data<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_node</span> <span class="token operator">*</span>child <span class="token operator">=</span> node<span class="token operator">-></span>children<span class="token operator">-></span>head<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> child<span class="token punctuation">;</span> child <span class="token operator">=</span> child<span class="token operator">-></span>next<span class="token punctuation">)</span>
        <span class="token function">recursive_subscription</span><span class="token punctuation">(</span>child<span class="token operator">-></span>data<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">topic</span> <span class="token operator">*</span>t <span class="token operator">=</span> node<span class="token operator">-></span>data<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">subscriber</span> <span class="token operator">*</span>s <span class="token operator">=</span> arg<span class="token punctuation">;</span>
    t<span class="token operator">-></span>subscribers <span class="token operator">=</span> <span class="token function">list_push</span><span class="token punctuation">(</span>t<span class="token operator">-></span>subscribers<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// SUBSCRIBE 处理器</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">subscribe_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">closure</span> <span class="token operator">*</span>cb<span class="token punctuation">,</span> <span class="token keyword">union</span> mqtt_packet <span class="token operator">*</span>pkt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token operator">*</span>c <span class="token operator">=</span> cb<span class="token operator">-></span>obj<span class="token punctuation">;</span>
    bool wildcard <span class="token operator">=</span> false<span class="token punctuation">;</span>          <span class="token comment">// 标记是否通配</span>
    bool alloced <span class="token operator">=</span> false<span class="token punctuation">;</span>           <span class="token comment">// 表示有新 malloc 的string, 用完需要释放</span>

    <span class="token comment">// 在 SUBACK 中使用和 SUB 同样的主题顺序回复的 QoS List</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> rcs<span class="token punctuation">[</span>pkt<span class="token operator">-></span>subscribe<span class="token punctuation">.</span>tuples_len<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// SUBSCRIBE 包含了主题和QoS的列表, 此处循环处理</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pkt<span class="token operator">-></span>subscribe<span class="token punctuation">.</span>tuples_len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"Received SUBSCRIBE from %s"</span><span class="token punctuation">,</span> c<span class="token operator">-></span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获得单个元组的主题字符串和QoS</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>topic <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> pkt<span class="token operator">-></span>subscribe<span class="token punctuation">.</span>tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>topic<span class="token punctuation">;</span>
        <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"\t%s (QoS %i)"</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> pkt<span class="token operator">-></span>subscribe<span class="token punctuation">.</span>tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>qos<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 当使用 /# 结尾时, 标记通配</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>topic<span class="token punctuation">[</span>pkt<span class="token operator">-></span>subscribe<span class="token punctuation">.</span>tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>topic_len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'#'</span> <span class="token operator">&amp;&amp;</span>
            topic<span class="token punctuation">[</span>pkt<span class="token operator">-></span>subscribe<span class="token punctuation">.</span>tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>topic_len <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            topic <span class="token operator">=</span> <span class="token function">remove_occur</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token char">'#'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            wildcard <span class="token operator">=</span> true<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>topic<span class="token punctuation">[</span>pkt<span class="token operator">-></span>subscribe<span class="token punctuation">.</span>tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>topic_len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 如果不以 / 结尾, 添加 /</span>
            topic <span class="token operator">=</span> <span class="token function">append_string</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> pkt<span class="token operator">-></span>subscribe<span class="token punctuation">.</span>tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>topic<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            alloced <span class="token operator">=</span> true<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 通过 topic 字符串找到对象</span>
        <span class="token keyword">struct</span> <span class="token class-name">topic</span> <span class="token operator">*</span>t <span class="token operator">=</span> <span class="token function">sol_topic_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sol<span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 当没有找到对象时, 创建并添加到特里树</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            t <span class="token operator">=</span> <span class="token function">topic_create</span><span class="token punctuation">(</span><span class="token function">strdup</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sol_topic_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sol<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>wildcard <span class="token operator">==</span> true<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">struct</span> <span class="token class-name">subscriber</span> <span class="token operator">*</span>sub <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>sub<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sub<span class="token operator">-></span>client <span class="token operator">=</span> cb<span class="token operator">-></span>obj<span class="token punctuation">;</span>
            sub<span class="token operator">-></span>qos <span class="token operator">=</span> pkt<span class="token operator">-></span>subscribe<span class="token punctuation">.</span>tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>qos<span class="token punctuation">;</span>
            <span class="token comment">// 让该节点和所有子节点都拥有表示此客户端的 subscriber</span>
            <span class="token function">trie_prefix_map_tuple</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sol<span class="token punctuation">.</span>topics<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> recursive_subscription<span class="token punctuation">,</span> sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 暂时都使用 cleansession = true</span>
        <span class="token comment">// 译者觉得在通配符的情况下这里会到这 topic 对应的节点产生两个 subscriber</span>
        <span class="token function">topic_add_subscriber</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> cb<span class="token operator">-></span>obj<span class="token punctuation">,</span> pkt<span class="token operator">-></span>subscribe<span class="token punctuation">.</span>tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>qos<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>alloced<span class="token punctuation">)</span>
            <span class="token function">free</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rcs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> pkt<span class="token operator">-></span>subscribe<span class="token punctuation">.</span>tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>qos<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 制作 suback</span>
    <span class="token keyword">struct</span> <span class="token class-name">mqtt_suback</span> <span class="token operator">*</span>suback <span class="token operator">=</span> <span class="token function">mqtt_packet_suback</span><span class="token punctuation">(</span>SUBACK_BYTE<span class="token punctuation">,</span>
                                                    pkt<span class="token operator">-></span>subscribe<span class="token punctuation">.</span>pkt_id<span class="token punctuation">,</span>
                                                    rcs<span class="token punctuation">,</span>
                                                    pkt<span class="token operator">-></span>subscribe<span class="token punctuation">.</span>tuples_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 复用pkt</span>
    <span class="token function">mqtt_packet_release</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> SUBSCRIBE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pkt<span class="token operator">-></span>suback <span class="token operator">=</span> <span class="token operator">*</span>suback<span class="token punctuation">;</span>
    <span class="token comment">// 制作数据流并发出</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>packed <span class="token operator">=</span> <span class="token function">pack_mqtt_packet</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> SUBACK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> len <span class="token operator">=</span> MQTT_HEADER_LEN <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span> <span class="token operator">+</span> pkt<span class="token operator">-></span>subscribe<span class="token punctuation">.</span>tuples_len<span class="token punctuation">;</span>
    cb<span class="token operator">-></span>payload <span class="token operator">=</span> <span class="token function">bytestring_create</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>cb<span class="token operator">-></span>payload<span class="token operator">-></span>data<span class="token punctuation">,</span> packed<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mqtt_packet_release</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> SUBACK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>suback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"Sending SUBACK to %s"</span><span class="token punctuation">,</span> c<span class="token operator">-></span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> REARM_W<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// UNSUBSCRIBE 处理器 这里没做实际处理, 只是正确回复ACK</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">unsubscribe_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">closure</span> <span class="token operator">*</span>cb<span class="token punctuation">,</span> <span class="token keyword">union</span> mqtt_packet <span class="token operator">*</span>pkt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token operator">*</span>c <span class="token operator">=</span> cb<span class="token operator">-></span>obj<span class="token punctuation">;</span>
    <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"Received UNSUBSCRIBE from %s"</span><span class="token punctuation">,</span> c<span class="token operator">-></span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pkt<span class="token operator">-></span>ack <span class="token operator">=</span> <span class="token operator">*</span><span class="token function">mqtt_packet_ack</span><span class="token punctuation">(</span>UNSUBACK_BYTE<span class="token punctuation">,</span> pkt<span class="token operator">-></span>unsubscribe<span class="token punctuation">.</span>pkt_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>packed <span class="token operator">=</span> <span class="token function">pack_mqtt_packet</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> UNSUBACK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cb<span class="token operator">-></span>payload <span class="token operator">=</span> <span class="token function">bytestring_create</span><span class="token punctuation">(</span>MQTT_ACK_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>cb<span class="token operator">-></span>payload<span class="token operator">-></span>data<span class="token punctuation">,</span> packed<span class="token punctuation">,</span> MQTT_ACK_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"Sending UNSUBACK to %s"</span><span class="token punctuation">,</span> c<span class="token operator">-></span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> REARM_W<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="PUBLISH-处理器"><a href="#PUBLISH-处理器" class="headerlink" title="PUBLISH 处理器"></a>PUBLISH 处理器</h2><p>PUBLISH 处理器会比我们前面写的几个内容多一些，但是十分好理解：</p>
<ul>
<li>如果发布的主题不存在, 则创建</li>
<li>基于消息的 QoS 设置，使用正确的 ACK 回复：<ul>
<li>QoS0：至多一次，不回复</li>
<li>QoS1：至少一次，使用 PUBACK 回复</li>
<li>QoS2：确保一次，使用 PUBREC 回复</li>
</ul>
</li>
<li>向该主题的订阅者转发该消息，转发的 QoS 值应该是由消息的 QoS 决定，但不能大于接收方设置的最大 QoS 值</li>
</ul>
<p><img src="/2023/12/29/translate-sol-6/QoS2-sample.png" srcset="/img/loading.gif" lazyload alt="Broker 接收一条 QoS2 的消息，并向 QoS1 的订阅者转发"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><div class="caption"><span>src/server.c</span></div><code class="language-c"><span class="token comment">// PUBLISH 处理器</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">publish_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">closure</span> <span class="token operator">*</span>cb<span class="token punctuation">,</span> <span class="token keyword">union</span> mqtt_packet <span class="token operator">*</span>pkt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token operator">*</span>c <span class="token operator">=</span> cb<span class="token operator">-></span>obj<span class="token punctuation">;</span>
    <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"Received PUBLISH from %s (d%i, q%u, r%i, m%u, %s, ... (%i bytes))"</span><span class="token punctuation">,</span>
              c<span class="token operator">-></span>client_id<span class="token punctuation">,</span>
              pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>header<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>dup<span class="token punctuation">,</span> pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>header<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>qos<span class="token punctuation">,</span>
              pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>header<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>retain<span class="token punctuation">,</span> pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>pkt_id<span class="token punctuation">,</span>
              pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>topic<span class="token punctuation">,</span> pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>payloadlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 数据记录</span>
    info<span class="token punctuation">.</span>messages_recv<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>topic <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>topic<span class="token punctuation">;</span>
    bool alloced <span class="token operator">=</span> false<span class="token punctuation">;</span> <span class="token comment">// 标记字符串空间是分配的</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> qos <span class="token operator">=</span> pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>header<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>qos<span class="token punctuation">;</span>

    <span class="token comment">// 保证所有的主题都是用 / 结尾</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>topic<span class="token punctuation">[</span>pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>topiclen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        topic <span class="token operator">=</span> <span class="token function">append_string</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>topic<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        alloced <span class="token operator">=</span> true<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 获得或创建基于该 kye 的 topic 对象</span>
    <span class="token keyword">struct</span> <span class="token class-name">topic</span> <span class="token operator">*</span>t <span class="token operator">=</span> <span class="token function">sol_topic_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sol<span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        t <span class="token operator">=</span> <span class="token function">topic_create</span><span class="token punctuation">(</span><span class="token function">strdup</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sol_topic_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sol<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>alloced <span class="token operator">==</span> true<span class="token punctuation">)</span>
        <span class="token function">free</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> publen<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pub<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_node</span> <span class="token operator">*</span>cur <span class="token operator">=</span> t<span class="token operator">-></span>subscribers<span class="token operator">-></span>head<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> cur<span class="token punctuation">;</span> cur <span class="token operator">=</span> cur<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        publen <span class="token operator">=</span> MQTT_HEADER_LEN <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>topiclen <span class="token operator">+</span> pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>payloadlen<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">subscriber</span> <span class="token operator">*</span>sub <span class="token operator">=</span> cur<span class="token operator">-></span>data<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token operator">*</span>sc <span class="token operator">=</span> sub<span class="token operator">-></span>client<span class="token punctuation">;</span>

        <span class="token comment">// 将 QoS 设置为订阅者的 QoS （此处为方便设计，并未完全遵循协议）</span>
        pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>header<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>qos <span class="token operator">=</span> sub<span class="token operator">-></span>qos<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>header<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>qos <span class="token operator">></span> AT_MOST_ONCE<span class="token punctuation">)</span>
            publen <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> remaininglen_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>publen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0x200000</span><span class="token punctuation">)</span>
            remaininglen_offset <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>publen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0x4000</span><span class="token punctuation">)</span>
            remaininglen_offset <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>publen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0x80</span><span class="token punctuation">)</span>
            remaininglen_offset <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        publen <span class="token operator">+=</span> remaininglen_offset<span class="token punctuation">;</span>
        <span class="token comment">// 发送给该订阅者的 PUB 包</span>
        pub <span class="token operator">=</span> <span class="token function">pack_mqtt_packet</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> PUBLISH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ssize_t</span> sent<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sent <span class="token operator">=</span> <span class="token function">send_bytes</span><span class="token punctuation">(</span>sc<span class="token operator">-></span>fd<span class="token punctuation">,</span> pub<span class="token punctuation">,</span> publen<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">sol_error</span><span class="token punctuation">(</span><span class="token string">"Error publishing to %s: %s"</span><span class="token punctuation">,</span>
                      sc<span class="token operator">-></span>client_id<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 记录信息</span>
        info<span class="token punctuation">.</span>bytes_sent <span class="token operator">+=</span> sent<span class="token punctuation">;</span>
        <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"Sending PUBLISH to %s (d%i, q%u, r%i, m%u, %s, ... (%i bytes))"</span><span class="token punctuation">,</span>
                  sc<span class="token operator">-></span>client_id<span class="token punctuation">,</span>
                  pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>header<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>dup<span class="token punctuation">,</span>
                  pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>header<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>qos<span class="token punctuation">,</span>
                  pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>header<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>retain<span class="token punctuation">,</span>
                  pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>pkt_id<span class="token punctuation">,</span>
                  pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>topic<span class="token punctuation">,</span>
                  pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>payloadlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        info<span class="token punctuation">.</span>messages_sent<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>pub<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 至少一次 使用ACK回复</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>qos <span class="token operator">==</span> AT_LEAST_ONCE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        mqtt_puback <span class="token operator">*</span>puback <span class="token operator">=</span> <span class="token function">mqtt_packet_ack</span><span class="token punctuation">(</span>PUBACK_BYTE<span class="token punctuation">,</span> pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>pkt_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mqtt_packet_release</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> PUBLISH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pkt<span class="token operator">-></span>ack <span class="token operator">=</span> <span class="token operator">*</span>puback<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>packed <span class="token operator">=</span> <span class="token function">pack_mqtt_packet</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> PUBACK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cb<span class="token operator">-></span>payload <span class="token operator">=</span> <span class="token function">bytestring_create</span><span class="token punctuation">(</span>MQTT_ACK_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>cb<span class="token operator">-></span>payload<span class="token operator">-></span>data<span class="token punctuation">,</span> packed<span class="token punctuation">,</span> MQTT_ACK_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"Sending PUBACK to %s"</span><span class="token punctuation">,</span> c<span class="token operator">-></span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> REARM_W<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>qos <span class="token operator">==</span> EXACTLY_ONCE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 确保一次 使用 PUBREC 回复</span>

        <span class="token comment">// TODO 需要通过一个哈希表记录已经处于 PUBREC 状态的客户端+包id</span>
        mqtt_pubrec <span class="token operator">*</span>pubrec <span class="token operator">=</span> <span class="token function">mqtt_packet_ack</span><span class="token punctuation">(</span>PUBREC_BYTE<span class="token punctuation">,</span> pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>pkt_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mqtt_packet_release</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> PUBLISH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pkt<span class="token operator">-></span>ack <span class="token operator">=</span> <span class="token operator">*</span>pubrec<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>packed <span class="token operator">=</span> <span class="token function">pack_mqtt_packet</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> PUBREC<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cb<span class="token operator">-></span>payload <span class="token operator">=</span> <span class="token function">bytestring_create</span><span class="token punctuation">(</span>MQTT_ACK_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>cb<span class="token operator">-></span>payload<span class="token operator">-></span>data<span class="token punctuation">,</span> packed<span class="token punctuation">,</span> MQTT_ACK_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"Sending PUBREC to %s"</span><span class="token punctuation">,</span> c<span class="token operator">-></span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> REARM_W<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 至多一次 无需回复</span>
    <span class="token function">mqtt_packet_release</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> PUBLISH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> REARM_R<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="ACK-PINGREQ-处理器"><a href="#ACK-PINGREQ-处理器" class="headerlink" title="ACK PINGREQ 处理器"></a>ACK PINGREQ 处理器</h2><p>只剩下 ACK 处理器了，他们基本上都是一样的。现在我们只做基本的日志和回复，以后我们再来实现基于 QoS 的业务机制。</p>
<p>还有 PINGREQ 处理器，这是客户端用来确认链接状态的心跳报文，我们只需要用 PINGRESP 回复即可。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><div class="caption"><span>src/server.c</span></div><code class="language-c"><span class="token comment">// PUBACK 处理器</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">puback_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">closure</span> <span class="token operator">*</span>cb<span class="token punctuation">,</span> <span class="token keyword">union</span> mqtt_packet <span class="token operator">*</span>pkt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"Received PUBACK from %s"</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token operator">*</span><span class="token punctuation">)</span> cb<span class="token operator">-></span>obj<span class="token punctuation">)</span><span class="token operator">-></span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO 基于QoS机制, 将该数据移出需重传列表</span>
    <span class="token keyword">return</span> REARM_R<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// PUBREC 处理器</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">pubrec_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">closure</span> <span class="token operator">*</span>cb<span class="token punctuation">,</span> <span class="token keyword">union</span> mqtt_packet <span class="token operator">*</span>pkt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token operator">*</span>c <span class="token operator">=</span> cb<span class="token operator">-></span>obj<span class="token punctuation">;</span>
    <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"Received PUBREC from %s"</span><span class="token punctuation">,</span> c<span class="token operator">-></span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 按照协议使用 RELEASE 回复 RECIVE</span>
    mqtt_pubrel <span class="token operator">*</span>pubrel <span class="token operator">=</span> <span class="token function">mqtt_packet_ack</span><span class="token punctuation">(</span>PUBREL_BYTE<span class="token punctuation">,</span> pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>pkt_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pkt<span class="token operator">-></span>ack <span class="token operator">=</span> <span class="token operator">*</span>pubrel<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>packed <span class="token operator">=</span> <span class="token function">pack_mqtt_packet</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> PUBREC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cb<span class="token operator">-></span>payload <span class="token operator">=</span> <span class="token function">bytestring_create</span><span class="token punctuation">(</span>MQTT_ACK_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>cb<span class="token operator">-></span>payload<span class="token operator">-></span>data<span class="token punctuation">,</span> packed<span class="token punctuation">,</span> MQTT_ACK_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"Sending PUBREL to %s"</span><span class="token punctuation">,</span> c<span class="token operator">-></span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> REARM_W<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// PUBREL 处理器</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">pubrel_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">closure</span> <span class="token operator">*</span>cb<span class="token punctuation">,</span> <span class="token keyword">union</span> mqtt_packet <span class="token operator">*</span>pkt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"Received PUBREL from %s"</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token operator">*</span><span class="token punctuation">)</span> cb<span class="token operator">-></span>obj<span class="token punctuation">)</span><span class="token operator">-></span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 按照协议使用 COMPLETE 回复 RELEASE</span>
    mqtt_pubcomp <span class="token operator">*</span>pubcomp <span class="token operator">=</span> <span class="token function">mqtt_packet_ack</span><span class="token punctuation">(</span>PUBCOMP_BYTE<span class="token punctuation">,</span> pkt<span class="token operator">-></span>publish<span class="token punctuation">.</span>pkt_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pkt<span class="token operator">-></span>ack <span class="token operator">=</span> <span class="token operator">*</span>pubcomp<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>packed <span class="token operator">=</span> <span class="token function">pack_mqtt_packet</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> PUBCOMP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cb<span class="token operator">-></span>payload <span class="token operator">=</span> <span class="token function">bytestring_create</span><span class="token punctuation">(</span>MQTT_ACK_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>cb<span class="token operator">-></span>payload<span class="token operator">-></span>data<span class="token punctuation">,</span> packed<span class="token punctuation">,</span> MQTT_ACK_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"Sending PUBCOMP to %s"</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token operator">*</span><span class="token punctuation">)</span> cb<span class="token operator">-></span>obj<span class="token punctuation">)</span><span class="token operator">-></span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> REARM_W<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// PUBCOMP 处理器</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">pubcomp_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">closure</span> <span class="token operator">*</span>cb<span class="token punctuation">,</span> <span class="token keyword">union</span> mqtt_packet <span class="token operator">*</span>pkt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"Received PUBCOMP from %s"</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token operator">*</span><span class="token punctuation">)</span> cb<span class="token operator">-></span>obj<span class="token punctuation">)</span><span class="token operator">-></span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO 基于 QoS 机制将其从待确认列表移出</span>
    <span class="token keyword">return</span> REARM_R<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// PINGREQ 处理器</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">pingreq_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">closure</span> <span class="token operator">*</span>cb<span class="token punctuation">,</span> <span class="token keyword">union</span> mqtt_packet <span class="token operator">*</span>pkt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"Received PINGREQ from %s"</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token operator">*</span><span class="token punctuation">)</span> cb<span class="token operator">-></span>obj<span class="token punctuation">)</span><span class="token operator">-></span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 按照协议使用 PINGRESP 回复</span>
    pkt<span class="token operator">-></span>header <span class="token operator">=</span> <span class="token operator">*</span><span class="token function">mqtt_packet_header</span><span class="token punctuation">(</span>PINGRESP_BYTE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>packed <span class="token operator">=</span> <span class="token function">pack_mqtt_packet</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> PINGRESP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cb<span class="token operator">-></span>payload <span class="token operator">=</span> <span class="token function">bytestring_create</span><span class="token punctuation">(</span>MQTT_HEADER_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>cb<span class="token operator">-></span>payload<span class="token operator">-></span>data<span class="token punctuation">,</span> packed<span class="token punctuation">,</span> MQTT_HEADER_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sol_debug</span><span class="token punctuation">(</span><span class="token string">"Sending PINGRESP to %s"</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sol_client</span> <span class="token operator">*</span><span class="token punctuation">)</span> cb<span class="token operator">-></span>obj<span class="token punctuation">)</span><span class="token operator">-></span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> REARM_W<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>现在我们的 broker 已经具有基本的功能，很快就可以和其他的 MQTT 工具联调测试，例如使用 <code>mosquitto_sub</code> 和 <code>mosquitto_pub</code> 或 Python 中的 <code>paho-mqtt</code>。</p>
<h1 id="配置模块"><a href="#配置模块" class="headerlink" title="配置模块"></a>配置模块</h1><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>我们需要一个配置模块来设置各种参数，使用最经典的键值对的方式：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-conf" data-language="conf"><div class="caption"><span>conf/sol.conf</span></div><code class="language-conf"># Sol configuration file, uncomment and edit desired configuration

# Network configuration

# Uncomment ip_address and ip_port to set socket family to TCP, if unix_socket
# is set, UNIX family socket will be used

# ip_address 127.0.0.1
# ip_port 9090

unix_socket &#x2F;tmp&#x2F;sol.sock

# Logging configuration

# Could be either DEBUG, INFO&#x2F;INFORMATION, WARNING, ERROR
log_level DEBUG

log_path &#x2F;tmp&#x2F;sol.log

# Max memory to be used, after which the system starts to reclaim memory by
# freeing older items stored
max_memory 2GB

# Max memory that will be allocated for each request
max_request_size 50MB

# TCP backlog, size of the complete connection queue
tcp_backlog 128

# Interval of time between one stats publish on $SOL topics and the subsequent
stats_publish_interval 10s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="配置模块定义"><a href="#配置模块定义" class="headerlink" title="配置模块定义"></a>配置模块定义</h2><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><div class="caption"><span>src/config.h</span></div><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token comment">// 默认参数</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VERSION</span>                     <span class="token string">"0.0.1"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_SOCKET_FAMILY</span>       <span class="token expression">INET</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_LOG_LEVEL</span>           <span class="token expression">DEBUG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_LOG_PATH</span>            <span class="token string">"/tmp/sol.log"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_CONF_PATH</span>           <span class="token string">"/etc/sol/sol.conf"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_HOSTNAME</span>            <span class="token string">"127.0.0.1"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_PORT</span>                <span class="token string">"1883"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_MAX_MEMORY</span>          <span class="token string">"2GB"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_MAX_REQUEST_SIZE</span>    <span class="token string">"2MB"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_STATS_INTERVAL</span>      <span class="token string">"10s"</span></span>

<span class="token keyword">struct</span> <span class="token class-name">config</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/* Sol version &lt;MAJOR.MINOR.PATCH> */</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>version<span class="token punctuation">;</span>
    <span class="token comment">/* Eventfd to break the epoll_wait loop in case of signals */</span>
    <span class="token keyword">int</span> run<span class="token punctuation">;</span>
    <span class="token comment">/* Logging level, to be set by reading configuration */</span>
    <span class="token keyword">int</span> loglevel<span class="token punctuation">;</span>
    <span class="token comment">/* Epoll wait timeout, define even the number of times per second that the
       system will check for expired keys */</span>
    <span class="token keyword">int</span> epoll_timeout<span class="token punctuation">;</span>
    <span class="token comment">/* Socket family (Unix domain or TCP) */</span>
    <span class="token keyword">int</span> socket_family<span class="token punctuation">;</span>
    <span class="token comment">/* Log file path */</span>
    <span class="token keyword">char</span> logpath<span class="token punctuation">[</span><span class="token number">0xFF</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/* Hostname to listen on */</span>
    <span class="token keyword">char</span> hostname<span class="token punctuation">[</span><span class="token number">0xFF</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/* Port to open while listening, only if socket_family is INET,
     * otherwise it's ignored */</span>
    <span class="token keyword">char</span> port<span class="token punctuation">[</span><span class="token number">0xFF</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/* Max memory to be used, after which the system starts to reclaim back by
     * freeing older items stored */</span>
    <span class="token class-name">size_t</span> max_memory<span class="token punctuation">;</span>
    <span class="token comment">/* Max memory request can allocate */</span>
    <span class="token class-name">size_t</span> max_request_size<span class="token punctuation">;</span>
    <span class="token comment">/* TCP backlog size */</span>
    <span class="token keyword">int</span> tcp_backlog<span class="token punctuation">;</span>
    <span class="token comment">/* Delay between every automatic publish of broker stats on topic */</span>
    <span class="token class-name">size_t</span> stats_pub_interval<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 全局配置对象</span>
<span class="token keyword">extern</span> <span class="token keyword">struct</span> <span class="token class-name">config</span> <span class="token operator">*</span>conf<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">config_set_default</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">config_print</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">config_load</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">time_to_string</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">memory_to_string</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>配置项目无需过多解释，都可以通过名称了解其作用。</p>
<h2 id="配置模块实现"><a href="#配置模块实现" class="headerlink" title="配置模块实现"></a>配置模块实现</h2><p>配置项主要是使用工具将配置文件的字符串信息解析成配置对象的值：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><div class="caption"><span>src/config.c</span></div><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ctype.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/eventfd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"util.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"config.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"network.h"</span></span>

<span class="token comment">// 全局对象</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">config</span> config<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">config</span> <span class="token operator">*</span>conf<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">llevel</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>lname<span class="token punctuation">;</span>
    <span class="token keyword">int</span> loglevel<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">llevel</span> lmap<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#123;</span><span class="token string">"DEBUG"</span><span class="token punctuation">,</span> DEBUG<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span><span class="token string">"WARNING"</span><span class="token punctuation">,</span> WARNING<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span><span class="token string">"ERROR"</span><span class="token punctuation">,</span> ERROR<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> INFORMATION<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span><span class="token string">"INFORMATION"</span><span class="token punctuation">,</span> INFORMATION<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 解析带单位的内存配置</span>
<span class="token keyword">static</span> <span class="token class-name">size_t</span> <span class="token function">read_memory_with_mul</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>memory_string<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 解析数字部分</span>
    <span class="token class-name">size_t</span> num <span class="token operator">=</span> <span class="token function">parse_int</span><span class="token punctuation">(</span>memory_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> mul <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 指针指向单位</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">isdigit</span><span class="token punctuation">(</span><span class="token operator">*</span>memory_string<span class="token punctuation">)</span><span class="token punctuation">)</span> memory_string<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token comment">// 通过单位获得乘系数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">STREQ</span><span class="token punctuation">(</span>memory_string<span class="token punctuation">,</span> <span class="token string">"kb"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        mul <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">STREQ</span><span class="token punctuation">(</span>memory_string<span class="token punctuation">,</span> <span class="token string">"mb"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        mul <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">STREQ</span><span class="token punctuation">(</span>memory_string<span class="token punctuation">,</span> <span class="token string">"gb"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        mul <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> num <span class="token operator">*</span> mul<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 解析带单位的时间配置(默认秒)</span>
<span class="token keyword">static</span> <span class="token class-name">size_t</span> <span class="token function">read_time_with_mul</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>time_string<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">size_t</span> num <span class="token operator">=</span> <span class="token function">parse_int</span><span class="token punctuation">(</span>time_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> mul <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">isdigit</span><span class="token punctuation">(</span><span class="token operator">*</span>time_string<span class="token punctuation">)</span><span class="token punctuation">)</span> time_string<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token operator">*</span>time_string<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token char">'m'</span><span class="token operator">:</span>
            mul <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token char">'d'</span><span class="token operator">:</span>
            mul <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            mul <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> num <span class="token operator">*</span> mul<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 将内存数字转为人类易读的字符串 例如  1024 => 1Kb</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">memory_to_string</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> memory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> numlen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> translated_memory <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>mstring <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>memory <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        translated_memory <span class="token operator">=</span> memory<span class="token punctuation">;</span>
        numlen <span class="token operator">=</span> <span class="token function">number_len</span><span class="token punctuation">(</span>translated_memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 数字 + 'b'</span>
        mstring <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>numlen <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>mstring<span class="token punctuation">,</span> numlen <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"%db"</span><span class="token punctuation">,</span> translated_memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>memory <span class="token operator">&lt;</span> <span class="token number">1048576</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        translated_memory <span class="token operator">=</span> memory <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">;</span>
        numlen <span class="token operator">=</span> <span class="token function">number_len</span><span class="token punctuation">(</span>translated_memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// + "Kb"</span>
        mstring <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>numlen <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>mstring<span class="token punctuation">,</span> numlen <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"%dKb"</span><span class="token punctuation">,</span> translated_memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>memory <span class="token operator">&lt;</span> <span class="token number">1073741824</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        translated_memory <span class="token operator">=</span> memory <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        numlen <span class="token operator">=</span> <span class="token function">number_len</span><span class="token punctuation">(</span>translated_memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// + "Mb"</span>
        mstring <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>numlen <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>mstring<span class="token punctuation">,</span> numlen <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"%dMb"</span><span class="token punctuation">,</span> translated_memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        translated_memory <span class="token operator">=</span> memory <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        numlen <span class="token operator">=</span> <span class="token function">number_len</span><span class="token punctuation">(</span>translated_memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// + "Gb"</span>
        mstring <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>numlen <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>mstring<span class="token punctuation">,</span> numlen <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"%dGb"</span><span class="token punctuation">,</span> translated_memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> mstring<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 将时间数字转为人类易读的字符串</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">time_to_string</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> time<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> numlen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> translated_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>tstring <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        translated_time <span class="token operator">=</span> time<span class="token punctuation">;</span>
        numlen <span class="token operator">=</span> <span class="token function">number_len</span><span class="token punctuation">(</span>translated_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tstring <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>numlen <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>tstring<span class="token punctuation">,</span> numlen <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"%ds"</span><span class="token punctuation">,</span> translated_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        translated_time <span class="token operator">=</span> time <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">;</span>
        numlen <span class="token operator">=</span> <span class="token function">number_len</span><span class="token punctuation">(</span>translated_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tstring <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>numlen <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>tstring<span class="token punctuation">,</span> numlen <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"%dm"</span><span class="token punctuation">,</span> translated_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        translated_time <span class="token operator">=</span> time <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        numlen <span class="token operator">=</span> <span class="token function">number_len</span><span class="token punctuation">(</span>translated_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tstring <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>numlen <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>tstring<span class="token punctuation">,</span> numlen <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"%dh"</span><span class="token punctuation">,</span> translated_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        translated_time <span class="token operator">=</span> time <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        numlen <span class="token operator">=</span> <span class="token function">number_len</span><span class="token punctuation">(</span>translated_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tstring <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>numlen <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>tstring<span class="token punctuation">,</span> numlen <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"%dd"</span><span class="token punctuation">,</span> translated_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> tstring<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 基于读取的 kv, 向配置对象赋值</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">add_config_value</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">size_t</span> klen <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> vlen <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">STREQ</span><span class="token punctuation">(</span><span class="token string">"log_level"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> klen<span class="token punctuation">)</span> <span class="token operator">==</span> true<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">STREQ</span><span class="token punctuation">(</span>lmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lname<span class="token punctuation">,</span> value<span class="token punctuation">,</span> vlen<span class="token punctuation">)</span> <span class="token operator">==</span> true<span class="token punctuation">)</span>
                config<span class="token punctuation">.</span>loglevel <span class="token operator">=</span> lmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>loglevel<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">STREQ</span><span class="token punctuation">(</span><span class="token string">"log_path"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> klen<span class="token punctuation">)</span> <span class="token operator">==</span> true<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>logpath<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">STREQ</span><span class="token punctuation">(</span><span class="token string">"unix_socket"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> klen<span class="token punctuation">)</span> <span class="token operator">==</span> true<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        config<span class="token punctuation">.</span>socket_family <span class="token operator">=</span> UNIX<span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>hostname<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">STREQ</span><span class="token punctuation">(</span><span class="token string">"ip_address"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> klen<span class="token punctuation">)</span> <span class="token operator">==</span> true<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        config<span class="token punctuation">.</span>socket_family <span class="token operator">=</span> INET<span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>hostname<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">STREQ</span><span class="token punctuation">(</span><span class="token string">"ip_port"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> klen<span class="token punctuation">)</span> <span class="token operator">==</span> true<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>port<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">STREQ</span><span class="token punctuation">(</span><span class="token string">"max_memory"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> klen<span class="token punctuation">)</span> <span class="token operator">==</span> true<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        config<span class="token punctuation">.</span>max_memory <span class="token operator">=</span> <span class="token function">read_memory_with_mul</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">STREQ</span><span class="token punctuation">(</span><span class="token string">"max_request_size"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> klen<span class="token punctuation">)</span> <span class="token operator">==</span> true<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        config<span class="token punctuation">.</span>max_request_size <span class="token operator">=</span> <span class="token function">read_memory_with_mul</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">STREQ</span><span class="token punctuation">(</span><span class="token string">"tcp_backlog"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> klen<span class="token punctuation">)</span> <span class="token operator">==</span> true<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> tcp_backlog <span class="token operator">=</span> <span class="token function">parse_int</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span>tcp_backlog <span class="token operator">=</span> tcp_backlog <span class="token operator">&lt;=</span> SOMAXCONN <span class="token operator">?</span> tcp_backlog <span class="token operator">:</span> SOMAXCONN<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">STREQ</span><span class="token punctuation">(</span><span class="token string">"stats_publish_interval"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> klen<span class="token punctuation">)</span> <span class="token operator">==</span> true<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        config<span class="token punctuation">.</span>stats_pub_interval <span class="token operator">=</span> <span class="token function">read_time_with_mul</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 去空格</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">strip_spaces</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">*</span>str<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">isspace</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>str<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token operator">*</span>str<span class="token punctuation">)</span> <span class="token operator">++</span><span class="token punctuation">(</span><span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">unpack_bytes</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>str<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>dest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>str <span class="token operator">||</span> <span class="token operator">!</span>dest<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isspace</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>str<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token operator">*</span>str<span class="token punctuation">)</span> <span class="token operator">*</span>dest<span class="token operator">++</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 读取配置</span>
<span class="token keyword">int</span> <span class="token function">config_load</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>configpath<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>configpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    FILE <span class="token operator">*</span>fh <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>configpath<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fh<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">sol_warning</span><span class="token punctuation">(</span><span class="token string">"WARNING: Unable to open conf file %s"</span><span class="token punctuation">,</span> configpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sol_warning</span><span class="token punctuation">(</span><span class="token string">"To specify a config file run sol -c /path/to/conf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">char</span> line<span class="token punctuation">[</span><span class="token number">0xff</span><span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token punctuation">[</span><span class="token number">0xff</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">[</span><span class="token number">0xff</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> linenr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>pline<span class="token punctuation">,</span> <span class="token operator">*</span>pkey<span class="token punctuation">,</span> <span class="token operator">*</span>pval<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> fh<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        linenr<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token comment">// 跳过注解</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'#'</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token comment">// 删除key前的空格</span>
        pline <span class="token operator">=</span> line<span class="token punctuation">;</span>
        <span class="token function">strip_spaces</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pline <span class="token operator">==</span> <span class="token char">'\0'</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token comment">// key</span>
        pkey <span class="token operator">=</span> key<span class="token punctuation">;</span>
        <span class="token function">unpack_bytes</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pline<span class="token punctuation">,</span> pkey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 删除 key 后空格</span>
        <span class="token function">strip_spaces</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 忽略错误的配置格式并提示</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">sol_warning</span><span class="token punctuation">(</span><span class="token string">"WARNING: Incomplete configuration '%s' at line %d. "</span>
                        <span class="token string">"Fallback to default."</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> linenr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 获得值</span>
        pval <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token function">unpack_bytes</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pline<span class="token punctuation">,</span> pval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 赋值</span>
        <span class="token function">add_config_value</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 设置默认参数</span>
<span class="token keyword">void</span> <span class="token function">config_set_default</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 全局配置对象指针</span>
    conf <span class="token operator">=</span> <span class="token operator">&amp;</span>config<span class="token punctuation">;</span>
    <span class="token comment">// 默认赋值</span>
    config<span class="token punctuation">.</span>version <span class="token operator">=</span> VERSION<span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>socket_family <span class="token operator">=</span> DEFAULT_SOCKET_FAMILY<span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>loglevel <span class="token operator">=</span> DEFAULT_LOG_LEVEL<span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>logpath<span class="token punctuation">,</span> DEFAULT_LOG_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>hostname<span class="token punctuation">,</span> DEFAULT_HOSTNAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>port<span class="token punctuation">,</span> DEFAULT_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>epoll_timeout <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>run <span class="token operator">=</span> <span class="token function">eventfd</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> EFD_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>max_memory <span class="token operator">=</span> <span class="token function">read_memory_with_mul</span><span class="token punctuation">(</span>DEFAULT_MAX_MEMORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>max_request_size <span class="token operator">=</span> <span class="token function">read_memory_with_mul</span><span class="token punctuation">(</span>DEFAULT_MAX_REQUEST_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>tcp_backlog <span class="token operator">=</span> SOMAXCONN<span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>stats_pub_interval <span class="token operator">=</span> <span class="token function">read_time_with_mul</span><span class="token punctuation">(</span>DEFAULT_STATS_INTERVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 配置输出</span>
<span class="token keyword">void</span> <span class="token function">config_print</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>loglevel <span class="token operator">&lt;</span> WARNING<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>sfamily <span class="token operator">=</span> config<span class="token punctuation">.</span>socket_family <span class="token operator">==</span> UNIX <span class="token operator">?</span> <span class="token string">"Unix"</span> <span class="token operator">:</span> <span class="token string">"Tcp"</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>llevel <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>loglevel <span class="token operator">==</span> config<span class="token punctuation">.</span>loglevel<span class="token punctuation">)</span>
                llevel <span class="token operator">=</span> lmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lname<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">sol_info</span><span class="token punctuation">(</span><span class="token string">"Sol v%s is starting"</span><span class="token punctuation">,</span> VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sol_info</span><span class="token punctuation">(</span><span class="token string">"Network settings:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sol_info</span><span class="token punctuation">(</span><span class="token string">"\tSocket family: %s"</span><span class="token punctuation">,</span> sfamily<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>socket_family <span class="token operator">==</span> UNIX<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">sol_info</span><span class="token punctuation">(</span><span class="token string">"\tUnix socket: %s"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>hostname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">sol_info</span><span class="token punctuation">(</span><span class="token string">"\tAddress: %s"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>hostname<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sol_info</span><span class="token punctuation">(</span><span class="token string">"\tPort: %s"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sol_info</span><span class="token punctuation">(</span><span class="token string">"\tTcp backlog: %d"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>tcp_backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>human_rsize <span class="token operator">=</span> <span class="token function">memory_to_string</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>max_request_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sol_info</span><span class="token punctuation">(</span><span class="token string">"\tMax request size: %s"</span><span class="token punctuation">,</span> human_rsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sol_info</span><span class="token punctuation">(</span><span class="token string">"Logging:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sol_info</span><span class="token punctuation">(</span><span class="token string">"\tlevel: %s"</span><span class="token punctuation">,</span> llevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sol_info</span><span class="token punctuation">(</span><span class="token string">"\tlogpath: %s"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>logpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>human_memory <span class="token operator">=</span> <span class="token function">memory_to_string</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>max_memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sol_info</span><span class="token punctuation">(</span><span class="token string">"Max memory: %s"</span><span class="token punctuation">,</span> human_memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> human_memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> human_rsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="主函数"><a href="#主函数" class="headerlink" title="主函数"></a>主函数</h1><p>最后的最后，<code>main</code> 函数：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><div class="caption"><span>src/sol.c</span></div><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_POSIX_C_SOURCE</span> <span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"util.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"config.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"server.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>addr <span class="token operator">=</span> DEFAULT_HOSTNAME<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>port <span class="token operator">=</span> DEFAULT_PORT<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>confpath <span class="token operator">=</span> DEFAULT_CONF_PATH<span class="token punctuation">;</span>
    <span class="token keyword">int</span> debug <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> opt<span class="token punctuation">;</span>
    <span class="token comment">// 使用默认值赋值</span>
    <span class="token function">config_set_default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 处理运行参数</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>opt <span class="token operator">=</span> <span class="token function">getopt</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"a:c:p:m:vn:"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>opt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> <span class="token char">'a'</span><span class="token operator">:</span>
                addr <span class="token operator">=</span> optarg<span class="token punctuation">;</span>
                <span class="token function">strcpy</span><span class="token punctuation">(</span>conf<span class="token operator">-></span>hostname<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token char">'c'</span><span class="token operator">:</span>
                confpath <span class="token operator">=</span> optarg<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token char">'p'</span><span class="token operator">:</span>
                port <span class="token operator">=</span> optarg<span class="token punctuation">;</span>
                <span class="token function">strcpy</span><span class="token punctuation">(</span>conf<span class="token operator">-></span>port<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token char">'v'</span><span class="token operator">:</span>
                debug <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span>
                        <span class="token string">"Usage: %s [-a addr] [-p port] [-c conf] [-v]\n"</span><span class="token punctuation">,</span>
                        argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 通过参数设置 debug 等级</span>
    conf<span class="token operator">-></span>loglevel <span class="token operator">=</span> debug <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> DEBUG <span class="token operator">:</span> WARNING<span class="token punctuation">;</span>
    <span class="token comment">// 读配置</span>
    <span class="token function">config_load</span><span class="token punctuation">(</span>confpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sol_log_init</span><span class="token punctuation">(</span>conf<span class="token operator">-></span>logpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 打印配置</span>
    <span class="token function">config_print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 运行服务</span>
    <span class="token function">start_server</span><span class="token punctuation">(</span>conf<span class="token operator">-></span>hostname<span class="token punctuation">,</span> conf<span class="token operator">-></span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sol_log_close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="构建与运行"><a href="#构建与运行" class="headerlink" title="构建与运行"></a>构建与运行</h1><p>我们的 <code>sol</code> 项目运行的所有所需内容都完成了：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">sol/
 ├── src/
 │    ├── mqtt.h
 │    ├── mqtt.c
 │    ├── network.h
 │    ├── network.c
 │    ├── list.h
 │    ├── list.c
 │    ├── hashtable.h
 │    ├── hashtable.c
 │    ├── server.h
 │    ├── server.c
 │    ├── trie.h
 │    ├── trie.c
 │    ├── util.h
 │    ├── util.c
 │    ├── core.h
 │    ├── core.c
 │    ├── config.h
 │    ├── config.c
 │    ├── pack.h
 │    ├── pack.c
 │    └── sol.c
 ├── conf
 │    └── sol.conf
 ├── CHANGELOG
 ├── CMakeLists.txt
 ├── COPYING
 └── README.md<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><code>sol</code> 项目的代码量并不算大，一般这种情况下我会编写 <code>Makefile</code> 用来控制编译。但是这一次，就像上方文件结构中描述的那样，我打算使用 <code>CMakeLists.txt</code> 来控制项目的构建：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cmake_minimum_required<span class="token punctuation">(</span>VERSION <span class="token number">2.8</span><span class="token punctuation">)</span>

project<span class="token punctuation">(</span>sol<span class="token punctuation">)</span>

OPTION<span class="token punctuation">(</span>DEBUG <span class="token string">"add debug flags"</span> OFF<span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span>
    message<span class="token punctuation">(</span>STATUS <span class="token string">"Configuring build for debug"</span><span class="token punctuation">)</span>
    set<span class="token punctuation">(</span>CMAKE_C_FLAGS <span class="token string">"<span class="token variable">$&#123;CMAKE_C_FLAGS&#125;</span> -Wall -Wunused -Werror -std=c11 -O3 -pedantic -luuid -ggdb -fsanitize=address -fsanitize=undefined -fno-omit-frame-pointer -pg"</span><span class="token punctuation">)</span>
<span class="token keyword">else</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span>
    message<span class="token punctuation">(</span>STATUS <span class="token string">"Configuring build for production"</span><span class="token punctuation">)</span>
    set<span class="token punctuation">(</span>CMAKE_C_FLAGS <span class="token string">"<span class="token variable">$&#123;CMAKE_C_FLAGS&#125;</span> -Wall -Wunused -Werror -Wextra -std=c11 -O3 -pedantic -luuid"</span><span class="token punctuation">)</span>
endif <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span>

set<span class="token punctuation">(</span>EXECUTABLE_OUTPUT_PATH <span class="token variable">$&#123;CMAKE_SOURCE_DIR&#125;</span><span class="token punctuation">)</span>

file<span class="token punctuation">(</span>GLOB SOURCES src/*.c<span class="token punctuation">)</span>

set<span class="token punctuation">(</span>AUTHOR <span class="token string">"Andrea Giacomo Baldan"</span><span class="token punctuation">)</span>
set<span class="token punctuation">(</span>LICENSE <span class="token string">"BSD2 license"</span><span class="token punctuation">)</span>

<span class="token comment"># Executable</span>
add_executable<span class="token punctuation">(</span>sol <span class="token variable">$&#123;SOURCES&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>唯一值得注意的就是我添加了 <code>DEBUG</code>  参数，这会产生一个带有监测内存泄漏参数版本的 <code>Makefile</code>。</p>
<p>所以接下来只需要生成 <code>Makefile</code></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ cmake <span class="token parameter variable">-DDEBUG</span><span class="token operator">=</span><span class="token number">1</span> <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>然后编译我们的代码</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">make</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>编译后得到名为 <strong>sol</strong> 的可执行程序，我们可以运行他来启动我们的 broker，程序支持我们上面编写的那些参数。</p>
<p>我们通过 <strong>-v</strong> (verbose) 参数启动程序，这样可以看到 <strong>debug</strong> 级别的日志信息。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ sol <span class="token parameter variable">-v</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<h1 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h1><p>好了，到此为止就是这么多内容，现在我们的代码也许有很多bug，有内存泄露问题，有很多需要修复或者重构的代码，但是软件的框架就是这样子了。第七部分很快就会编写完成，我打算用 <code>paho-mqtt</code> 进行一些测试。接下来你可以看看<a target="_blank" rel="noopener" href="https://codepr.github.io/posts/sol-mqtt-broker-bonus/">特别篇</a>，在那里我们会为 <strong>sol</strong> 添加多线程支持。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" class="category-chain-item">网络编程</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" class="print-no-link">#网络编程</a>
      
        <a href="/tags/%E7%BF%BB%E8%AF%91/" class="print-no-link">#翻译</a>
      
        <a href="/tags/%E7%89%A9%E8%81%94%E7%BD%91/" class="print-no-link">#物联网</a>
      
        <a href="/tags/C/" class="print-no-link">#C</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>[翻译]Sol - 从零开始的MQTT broker - 第六部分：处理器</div>
      <div>https://vitsumoc.github.io/2023/12/29/translate-sol-6.html</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>vc</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年12月29日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/01/01/review-2023.html" title="2023年度总结">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">2023年度总结</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/12/28/translate-sol-5.html" title="[翻译]Sol - 从零开始的MQTT broker - 第五部分：主题树">
                        <span class="hidden-mobile">[翻译]Sol - 从零开始的MQTT broker - 第五部分：主题树</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <span>vitusmoc Blog, Powered by </span> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script  src="https://lib.baomitu.com/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js" ></script>

  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
